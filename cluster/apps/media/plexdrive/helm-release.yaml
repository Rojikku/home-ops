---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: plexdrive
  namespace: media
spec:
  interval: 5m
  chart:
    spec:
      chart: plexdrive
      version: v0.1.0
      sourceRef:
        kind: HelmRepository
        name: rojikku-charts
        namespace: flux-system
      interval: 5m
  values:
    images:
      container:
        repository: wiserain/plexdrive
        tag: 5.2.1
      pullPolicy: IfNotPresent

    # Note: livenessProbe and startupProbe rely on the existence of a "health" file in the root of your mount. Create a file for this purpose.

    plexdrive:
      # mount path for  remote
      path: /mnt/plexdrive
      # read only file system for remote (to protect from deletion of files)

    # Args hardcoded to start with mount and end with /plexdrive (VM mount point)
    # args:
    #   - --config=/config/
    #   - --cache-file=/cache/cache.bolt
    #   - --uid=1000
    #   - --gid=1000
    #   - -o
    #   - allow_other
    #   - --root-node-id=
    #   - -v2

    volumes:
    # Media is hardcoded to host mount path above
      - name: cache
        hostPath:
          path: /cache
          type: DirectoryOrCreate
      - name: config
        configMap:
          name: plexdrive-config
          items:
            - key: "config.json"
              path: "config.json"
            - key: "token.json"
              path: "token.json"


    volumeMounts:
    # media is hardcoded to /plexdrive and Bidirectional
      - name: config
        mountPath: /config
        readOnly: true
      - name: cache
        mountPath: /cache


    resources:
      limits:
        smarter-devices/fuse: 1
      requests:
        smarter-devices/fuse: 1
        cpu: 10m
        memory: 100Mi
      # We usually recommend not to specify default resources and to leave this as a conscious
      # choice for the user. This also increases chances charts run on environments with little
      # resources, such as Minikube. If you do want to specify resources, uncomment the following
      # lines, adjust them as necessary, and remove the curly braces after 'resources:'.
      # requests:
      #   cpu: 100m
      #   memory: 100Mi
      # limits:
      #   cpu: 1000m
      #   memory: 2Gi

    nodeSelector:
      plexdrive: enabled

  valuesFrom:
    - kind: Secret
      name: "plexdrive"
      valuesKey: args
      optional: false
