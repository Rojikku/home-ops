---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: stash
  namespace: stash
spec:
  interval: 5m
  chart:
    spec:
      chart: stash
      # renovate: registryUrl=https://charts.appscode.com/stable/ chart=stash
      version: v2022.09.29
      sourceRef:
        kind: HelmRepository
        name: appscode-charts
        namespace: flux-system
  dependsOn:
    - name: rook-ceph-cluster
      namespace: rook-ceph
  values:
    features:
      community: true
    stash-community:
      # license: from secret
      crdInstaller:
        enabled: false
      operator:
        registry: stashed
        repository: stash
        # renovate: registryUrl=https://charts.appscode.com/stable/ chart=stash-community
        tag: v0.23.0
        resources:
          requests:
            cpu: "100m"
      # Installing a second, unnecessary pushgateway because chart maintainers didn't make it optional. Fix projected for v0.19.0!
      pushgateway:
        customURL: "http://pushgateway.monitoring:9091"
      cleaner:
        registry: appscode
        repository: kubectl
        tag: v1.16
        skip: false
      # Node labels for pod assignment
      nodeSelector: # +doc-gen:break
        beta.kubernetes.io/os: linux
        beta.kubernetes.io/arch: amd64
      monitoring:
        agent: "prometheus.io/operator"
        backup: true
        operator: true
      security:
        createPSPs:
          privileged: false
  valuesFrom:
    - kind: Secret
      name: "stash"
      optional: false
      valuesKey: license.txt
      targetPath: global.license
